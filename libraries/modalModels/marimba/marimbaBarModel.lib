import("stdfaust.lib");
import("lpm.lib");

nModes = 50;
nExPos = 2;
modesFreqs(n) = ba.take(n+1,(47.8195,158.452,183.373,385.575,451.788,675.061,879.114,1004.7,1251.79,1386.5,1772.8,1810.94,1915.81,2278.31,2439.7,2507.18,2787.21,3038.86,3125.61,3201.93,3563.99,3763.01,3865.6,4302.7,4445.59,4552,4661.47,5289.8,5359.07,5443.11,5707.53,6075.21,6215.65,6324.54,6382.8,6912.24,7146.04,7270.12,7324.32,7440.56,7564.21,8038.7,8218.38,8342.78,8556.68,8678.38,8865.63,9103.33,9190.44,9348.95));
modesGains(p,n) = waveform{0.0581789,0.354741,0.0679581,0.345522,0.320777,0.254097,0.35614,0.278147,0.0929636,0.403697,0.348424,0.069827,0.287201,0.0495683,0.148762,0.196103,0.425653,0.352456,0.346197,0.240561,0.148939,0.159515,0.089124,0.403031,0.240545,0.335812,0.0786828,0.208771,0.240942,0.0584054,0.204908,0.367509,0.384008,0.298199,0.258605,0.128581,0.204788,0.112438,1,0.114999,0.271346,0.350472,0.140471,0.223433,0.137514,0.217152,0.230762,0.33643,0.123154,0.348086,1,0.776725,0.625723,0.855223,0.760159,0.698373,0.768011,0.641127,0.244034,0.707754,0.634013,0.247527,0.660849,0.450396,0.567783,0.106361,0.716814,0.66392,0.291208,0.310599,0.801495,0.635292,0.307435,0.874124,0.497668,0.487088,0.459115,0.733455,0.541818,0.441318,0.31392,0.40309,0.685353,0.60314,0.400552,0.453511,0.634386,0.291547,0.131605,0.368507,0.839907,0.60216,0.288296,0.57967,0.0242493,0.262746,0.368588,0.890284,0.408963,0.556072},int(p*nModes+n) : rdtable;

marimbaBarModel(exPos,t60,t60DecayRatio,t60DecaySlope) = _ <: par(i,nModes,*(modesGains(int(exPos),i)) : modeFilter(modesFreqs(i),modesT60s(i))) :> /(nModes)
with{
modesT60s(i) = t60*pow(1-(modesFreqs(i)/9370.47 - 0.00510321)*(t60DecayRatio + 0.00510321),t60DecaySlope);
};
